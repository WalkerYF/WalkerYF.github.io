<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans,en,default">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">



  
  
  <link rel="stylesheet" href="/lib/Han/dist/han.min.css?v=3.3">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Tracing Part1 | Linux 中的新一代 tracing 技术 翻译自New generation tracing technologies for Linux operating system  在软件工程中，跟踪是通过将程序附加到受控系统中的各种探测点并收集信息来检查和记录有关软件执行的信息的能力。 此信息通常由软件开发人员用于调试目的，以及系统管理员用于保持对系统本身的控制。">
<meta name="keywords" content="Tracing,eBPF">
<meta property="og:type" content="article">
<meta property="og:title" content="tracing1">
<meta property="og:url" content="https://wwyf.github.io/2019/07/24/2019-07-2019-07-24-tracing1/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="Tracing Part1 | Linux 中的新一代 tracing 技术 翻译自New generation tracing technologies for Linux operating system  在软件工程中，跟踪是通过将程序附加到受控系统中的各种探测点并收集信息来检查和记录有关软件执行的信息的能力。 此信息通常由软件开发人员用于调试目的，以及系统管理员用于保持对系统本身的控制。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-07-24T14:28:41.012Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="tracing1">
<meta name="twitter:description" content="Tracing Part1 | Linux 中的新一代 tracing 技术 翻译自New generation tracing technologies for Linux operating system  在软件工程中，跟踪是通过将程序附加到受控系统中的各种探测点并收集信息来检查和记录有关软件执行的信息的能力。 此信息通常由软件开发人员用于调试目的，以及系统管理员用于保持对系统本身的控制。">



  <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">




  <link rel="canonical" href="https://wwyf.github.io/2019/07/24/2019-07-2019-07-24-tracing1/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>tracing1 | Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">My Blog</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wwyf.github.io/2019/07/24/2019-07-2019-07-24-tracing1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wyf">
      <meta itemprop="description" content="bilibala~ bilibala~">
      <meta itemprop="image" content="/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">tracing1

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-07-24 21:46:48 / Modified: 22:28:41" itemprop="dateCreated datePublished" datetime="2019-07-24T21:46:48+08:00">2019-07-24</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Tracing/" itemprop="url" rel="index"><span itemprop="name">Tracing</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/24/2019-07-2019-07-24-tracing1/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count valine-comment-count" data-xid="/2019/07/24/2019-07-2019-07-24-tracing1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/07/24/2019-07-2019-07-24-tracing1/" class="leancloud_visitors" data-flag-title="tracing1">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">8.1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">16 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Tracing-Part1-Linux-中的新一代-tracing-技术"><a href="#Tracing-Part1-Linux-中的新一代-tracing-技术" class="headerlink" title="Tracing Part1 | Linux 中的新一代 tracing 技术"></a>Tracing Part1 | Linux 中的新一代 tracing 技术</h1><blockquote>
<p>翻译自<br><a href="https://vncz.js.org/ebpf/" target="_blank" rel="noopener">New generation tracing technologies for Linux operating system</a></p>
</blockquote>
<p>在软件工程中，跟踪是通过将程序附加到受控系统中的各种探测点并收集信息来检查和记录有关软件执行的信息的能力。 此信息通常由软件开发人员用于调试目的，以及系统管理员用于保持对系统本身的控制。</p>
<p>在系统的不同级别上存在许多探测点：它们可以在我能深入检查的函数执行，例如，调用某个函数的参数; 它们可以放在内核中，例如，进入系统并由系统处理的网络数据包; 我们可以检查正在创建/暂停/终止的进程; 但它们也可以是应用程序级事件，如垃圾收集器的调用（如果由运行时环境提供），方法调用和依赖于运行时的事件（如NodeJS的http请求）。</p>
<p>无论来源如何，每当出现上述有趣事件之一时，跟踪工具允许我们执行某些有用的操作，例如在控制台上打印消息，检查事件的上下文，收集一些统计信息（系统需要多长时间处理 一个网络数据包或运行垃圾收集器），以便我们可以清楚地知道发生了什么。</p>
<p>所有跟踪工具最重要的要求之一是对系统的低开销。 如果跟踪工具使得系统速度减慢，那么获得的指标可能会产生误导。 此外，跟踪工具意味着在生产和开发模式下连续运行 。因此我们必须在系统上具有非常低开销的tracing工具。</p>
<p>多年来，很多跟踪工具和技术已经为Linux开发出来。 在增加的开销，易用性，他们能够提取的信息水平以及提供的功能以及最重要的限制方面，有些人比其他人更好; 所以 - 在进入eBPF之前（并理解为什么需要另外的跟踪技术），对Linux中的跟踪环境进行高级概述是有益的。</p>
<h2 id="Kernel-level-tracing-technologies-overview"><a href="#Kernel-level-tracing-technologies-overview" class="headerlink" title="Kernel level tracing technologies overview"></a>Kernel level tracing technologies overview</h2><p>有了某些内核技术，跟踪才得以进行。 最重要的是，我们有一些用户空间跟踪工具，它们使用上述作为构建块从系统中提取信息并收集有用的数据。</p>
<h3 id="Trace-points"><a href="#Trace-points" class="headerlink" title="Trace points"></a>Trace points</h3><p>Linux内核中有一种机制已经存在至少10年，称为静态跟踪点。 跟踪点是一个驻留在内核代码中的静态占位符，内核的特定部分的开发人员认为它可以作为挂钩点用于调试代码。</p>
<p>静态指的是它是一个固定点。 跟踪点的数量及其位置实际上取决于内核版本，更重要的是取决于内核开发人员对该特定区域的看法。 截至今天，当前内核版本有超过700个跟踪点，当然，所有这些都是无操作（即 - 没有执行任何操作）。</p>
<p>跟踪点真的是多种多样的，包括调度程序事件（新进程创建，进程切换，进程分支），网络事件（进入数据包，数据包出去），文件系统和阻塞IO事件（读，写）等内容。 每个内核系统调用甚至都有跟踪点（这是程序从内核请求服务的程序化方式，形成进程和操作系统之间的基本接口）。 所有内核版本都在其文档中包含可用跟踪点列表。</p>
<p>内核提供API（通过一组头文件）以便于使用这些跟踪点。 这些头包含一组宏，可用于设置内核模块以响应特定事件。 也可以根据我们的需要定义一个事件类（基本上是一组事件），并为整个类指定一个唯一的处理程序（将要执行的函数）。</p>
<p>目前几乎所有可用的跟踪工具都可以使用跟踪点附加到所需事件，收集信息并执行有用的统计和分析。</p>
<p>此外，Trace Point概念也到了系统的更高层次。 各种运行时环境实现了我们可以附加到其中并从中收集信息的详细跟踪点。 例如，在NodeJS中，您可以跟踪何时调用垃圾收集器，何时调用函数，或何时创建类对象，或何时发生IO阻塞操作。</p>
<p>静态跟踪点的流行和易用性导致它们被放置在许多常见的服务器应用程序中，包括MySQL和PostgreSQL等数据库，您可以使用query<strong>start和query</strong>done跟踪点检查查询执行时间。</p>
<p>Trace Point的最大限制是，正如其名称所示，它们的静态特性。 如果我们有兴趣跟踪原始开发人员在跟踪点放置期间没有真正考虑的软件的特定区域，我们唯一的可能性是分叉源代码，放置所需的跟踪点并运行fork来收集数据。 希望应该可以回馈主分支，但这可能是一个漫长的过程。</p>
<p>如果软件是封闭源代码，我们的可能性更小：唯一的方法是联系供应商并开始交易以获得软件的自定义构建，或等待更新。</p>
<h3 id="Dynamic-Probes"><a href="#Dynamic-Probes" class="headerlink" title="Dynamic Probes"></a>Dynamic Probes</h3><p>Kprobes和Uprobes是内核中内置的另一种机制。 这些已经存在了一段时间，可用于动态探测系统。</p>
<p>Kprobes和Uprobes不是将静态挂钩点放入内核或编程语言运行时环境或服务器应用程序中，而是允许我们在开发过程中随意选择函数，并在它之上附加程序，而无需在软件中进行任何准备或预置代码。 它既可以是用户空间功能（Uprobes），也可以是内核模块功能（Kprobes）。</p>
<p>它的工作方式与调试器断点非常相似：每当遇到探测时，都会抛出异常; 一个特殊的异常处理程序将捕获异常并执行与我们附加的探测相关的操作。</p>
<p>上面有一种替代实现方式更有效：不是抛出导致从内核空间到用户空间的上下文切换的异常（如果谈论Kprobe），只需用提供处理程序的跳转指令替换探测器。</p>
<p>Kprobes和Uprobes共享许多基础架构和功能集。 但是，由于它们在用户或内核空间中工作，因此存在一些小差异：</p>
<ol>
<li>Kprobes是全局性的，而Uprobes是本地的。 Uprobe专门附加在正在创建的进程上，不会影响其他正在运行的进程。 另一方面，Kprobes是全局的，因为它们直接附加在内核函数上，通常，不能保证获得进程句柄。</li>
<li>Uprobes支持动作和过滤的条件执行 - 此外，在用户空间上附加多个探测是一种预期的方案。</li>
</ol>
<h2 id="User-Level-Tracing-Tools"><a href="#User-Level-Tracing-Tools" class="headerlink" title="User Level Tracing Tools"></a>User Level Tracing Tools</h2><p>由于跟踪点和探测都是内核级技术，因此利用这些技术需要编写一个内核模块，该模块将附加到所选事件并以某种方式将其导出到最终用户应用程序 - 或最终在模块本身中收集数据。</p>
<p>显然，编写内核模块通常不是一个好主意，必须认真对待：即使是最小的错误也可能导致内核panic（这意味着系统停止），而且，处理内核模块意味着大多数隔离过程模型提供的保证可能不可用。</p>
<p>因此，当您编写内核模块时，您获得的所有跟踪信息不仅限于您当前的进程或shell：相反，您将获得可能不感兴趣的进程和子系统的事件。</p>
<p>此外，内核跟踪路径是全局的：如果另一个程序使用上面列出的某种内核技术启动跟踪过程，它最终可能会覆盖您的跟踪例程。</p>
<p>幸运的是，这种内核级技术并不是由用户直接使用。 这绝对是可能的，但其背后的目的是提供构建块来创建更精确和复杂的通用工具，能够从系统收集信息，而无需编写任何代码并保留完全从用户空间工作的可能性。</p>
<p>我们将快速浏览两个最着名的，但是，正如您在上一张图片中可能已经注意到的那样，跟踪工具还有很多。</p>
<h3 id="perf"><a href="#perf" class="headerlink" title="perf"></a>perf</h3><p> perf是Linux用户的主要跟踪工具。 它的源代码在Linux内核中，因此您可以通过基本安装获得它。 它最初被设想为从系统性能计数器收集信息的简单工具，但它的功能集一点一点地增加并成为通用的跟踪工具。 它以相对有效的方式将所有收集的数据转储到文件（perf.data），最终可以在以后发布。</p>
<p> 它错过了一些高级功能（例如，它不能执行功能流程，因为它具有更好的安全性/错误检查功能，因此不那么容易破解）。 它仍然可以进行分析（采样），CPU性能计数器，用户级堆栈转换，并且它可以使用debuginfo进行本地变量的行跟踪。 它还支持多个并发用户。</p>
<h3 id="ftrace"><a href="#ftrace" class="headerlink" title="ftrace"></a>ftrace</h3><p>ftrace是一个内核跟踪器，允许您监视内核的许多不同区域和活动。 即使它随内核一起提供，它也是独立开发的，其发布周期比内核本身更快。 实际上，每两到三个周期就会将新版本拉入内核树。</p>
<p>此工具从驻留在/sys/kernel/debug/tracing中的特殊文件系统读取数据。此目录包含多个文件，这些文件表示我们要跟踪的系统部分。 阅读该文件的内容是我们检查系统并弄清楚发生了什么所需要的全部内容。</p>
<p>还有一个更高级别的工具trace-cmd为您打开ftrace的输出文件，并找出我们可以使用命令行参数查询的有趣事件。</p>
<h3 id="Performance-limitations"><a href="#Performance-limitations" class="headerlink" title="Performance limitations"></a>Performance limitations</h3><p>这些工具（以及其他工具）都基于将收集的信息直接写入文件的概念。 为了提取我们需要的信息，我们必须将所有这些文件加载到后处理应用程序中（或最终传输这些文件），解析当前行，更新统计信息，然后移动到下一行。 不幸的是，如果所需的统计信息非常具体，您可能需要编写我们自己的后期处理应用程序。</p>
<p>只要后处理在一台单独的机器上进行就可以了（最好不要在生产中 - 或者至少在单独的过程中），但是如果我们想要收集实时数据，那么它实际上效率很低，所以完全不适用于 实时场景。</p>
<h2 id="eBPF"><a href="#eBPF" class="headerlink" title="eBPF"></a>eBPF</h2><p>eBPF（代表扩展的Berkley数据包过滤器）是一种相对较新的内核技术（它自3.15起正式成为内核的一部分，但其大多数功能都是在以下内核版本中引入的），旨在提供统一的跟踪解决方案以及克服所有问题 和当前跟踪工具的限制。</p>
<p>BPF代表Berkley Packet Filtering  -  eBPF诞生的原始技术，它比Linux内核本身存在的时间更长。</p>
<p>BPF背后的想法是提供一种分析和过滤网络数据包的方法，以便通过用户空间程序提供的简单无状态表达式进行监控。 此表达式一旦附加到目标套接字，将确保通过该套接字的每个数据包将针对它进行测试。</p>
<p>根据表达式求值返回的（布尔值），可以执行多个动作：丢弃数据包，记录数据包或让数据包继续处理管道。</p>
<p>不同的工具可以直接使用BPF表达式（tcpdump，wireshark），但是当然任何用户程序都可能使用套接字API附加自定义BPF程序。 由于这种机制，开发起来非常简单，例如，在最终应用程序甚至可以看到它们之前，每个应用程序防火墙消除了数据包。</p>
<p>最初的BFP发行版以用户空间库的形式出现，但由于性能原因，很快决定将其移入内核：网络数据包处理必须非常高效。</p>
<p>当网络流量很高时，在将不需要的数据包发送到用户空间之前过滤掉有很多潜在的性能提升：移动通用数据结构（不仅限于套接字，它也可以是文件描述符或内存） 从内核空间到用户空间不仅仅是复制一些内存区域的问题。 它还需要从数据结构本身修剪无用/无法访问的信息，更新进程的资源引用计数器以及使资源通过整个操作系统安全管道。 在内核空间中丢弃数据包（一般来说，避免将内容发送到用户空间），特别是当负载很高时，可以带来显着的性能提升。</p>
<p>显然，BPF程序运行起来非常重要，因为在高流量情况下，每个开销都会在很大程度上影响性能。</p>
<p>由于这种“移动”，BPF现在也在内核内部的多个区域内使用（内部数据包过滤，用于流量控制的数据包分类器等）。</p>
<p>幸运的是，BPF被定义为虚拟机，它几乎是图灵完整且兼容的，只有两个寄存器：累加器和索引。 该机器还有一个小内存区域，隐含地包含正在处理的数据包和有限的指令集。</p>
<p>这意味着每条BPF指令都可以轻松映射到x86指令序列，并且两个寄存器可以直接映射到CPU寄存器上 - 这表明不是解析表达式并在运行时对其进行评估，而是从BPF生成本机指令 计划是一种可行的方式。</p>
<p>的确，那件事发生了。 多年来，内核维护人员开始考虑将过滤表达式编译为最流行的体系结构（X86，X64，ARM，PowerPC）的高度优化的机器代码，而不是在运行时解析和执行它们。这是是一个好主意：BFP将成为 基本上很少的本机程序将被加载到内核并以机器速度执行的程序了。</p>
<p>这需要开发一个JIT编译器，该编译器最终在2011年作为内核补丁登陆，并且最初只适用于x86-64架构。 （公平地说，这不是一场特别的革命，因为自2005年以来FreeBSD一直在使用JIT进行BPF计划）</p>
<p>回到跟踪工具：虽然这些工具继续发展很大，但是内核仍然缺乏可编写脚本的动态跟踪系统，而是存在于其他系统上：DTrace（一个可编写脚本的跟踪工具）是最令人羡慕的，它可用 在Solaris，MacOS，NetBSD和FreeBSD上。 它允许系统分析业内无法比拟的范围和精度，以及大量的仪器供应商。</p>
<p>尽管Oracle在许可许可下发布了它，但将DTrace移植到Linux仍然存在问题：</p>
<ol>
<li>技术问题：DTrace具有内核中的一些功能，特别是处理无效内存访问的代码和一些基本的检测提供程序。 根据原作者的说法，它不到1500行代码，但是Linux和类UNIX操作系统家族之间的深刻差异使这件事变得微不足道，几乎无法克服，但无论如何都是可行的。</li>
</ol>
<ol>
<li>许可问题：虽然DTrace是在CCDL许可下发布的，但Oracle仍然拥有该软件。 CDDL有一些GPL中没有的限制：因此，将GPL代码（Linux内核）与CDDL代码（DTrace）相结合将导致工作在许可证不一致且无法合法分发。 Oracle希望将DTrace用于Linux，但将其直接集成到内核中显然会导致法律问题，并且最终的补丁会被拒绝，因此他们将其实现为双层内核模块。不幸的是，内核模块的版权有点不清楚。 GPL涵盖了衍生作品，但衍生作品的定义仍然是个人的，没有明确定义。利用明确导出的API可能不足以构成衍生作品 - 另一方面，它可能。 Oracle似乎认为它们是合法的，因此添加了足够的内核代码（并在GPL术语下发布）以支持DTrace，同时保持DTrace的CCDL核心分离。内核实际上有两级暴露（非用户空间）API - 通过EXPORT_SYMBOL（）导出的API和通过EXPORT_SYMBOL_GPL（）导出的API。通过EXPORT_SYMBOL_GPL（）导出的符号只能由声称为GPL的模块使用，否则内核拒绝加载它们。当然，作为DTrace的版权所有者，Oracle可以通过在GPL和CDDL下双重许可DTrace来解决问题。事实上，他们并没有暗示他们认为将其保持在不兼容的许可证下有足够的价值。</li>
</ol>
<p>虽然一些开发人员正在考虑向内核添加LUA解释器和虚拟机的想法，但事情却朝着不同的方向发展.3.15内核版本带来了eBPF的第一个版本。 基本上，语言分为两种变体：经典BPF和内部BPF。 后者是现有基础设施的改进和扩展版本，将寄存器数量从2扩展到10，提供对内核功能的有限访问，并添加真正接近真实CPU提供的指令，更重要的是 - 更容易 使用像GCC和LLVM这样的编译器工具链来生成。</p>
<p>最初，内部BPF，正如名称所声称的那样，并没有暴露，因为开发人员担心这种实现会随着时间的推移而改变，因此他们倾向于从经典BPF程序到内部BPF指令进行内部转换，至少最初是这样。</p>
<p>在3.16 BPF之后，当经典BPF被证明是稳定的并且所有关于实现变化的担忧消失时，决定将其重命名为扩展BPF并将其暴露给一般用途。</p>
<p>跟踪是首次使用eBPF进行测试的用例之一，因为乍一看它似乎能够解决不同的痛点，其中缺乏可编写脚本的系统以及快速探测处理。</p>
<p>在跟踪子系统内（独立于跟踪工具），给定的过滤器表达式通常被解析并表示为一个简单的树，每个内部节点代表一个运算符。 每次遇到跟踪点时，将走这棵树以评估当前存在的特定数据值的每个操作; 如果结果在树的顶部为真，则会触发跟踪点并发出相关信息。 换句话说，大多数跟踪工具都包含一个自己的小解析器和解释器，用于这个特定目的。</p>
<p>使用扩展的BPF，在另一个头上，将解析器留在原位，但使用JIT编译器删除解释器。 结果令人印象深刻，这表明值得继续以这种方式进行挖掘。</p>
<p>对于记录，一旦开发人员决定向用户空间公开和改进内部BPF，eBPF的用例就会爆炸。 使用eBPF而不是仅仅过滤数据包，您可以创建虚拟网络，根据您的偏好路由数据包，您可以允许或禁止特定系统调用特定进程，但更重要的是显着改进当前跟踪子系统。 eBPF在功能方面（克服静态跟踪点的限制或简化U / Kprobes的数据收集）和性能（它是一种以机器速度运行的可编程内核技术）开辟了新的可能性。</p>
<p>此外，无论技术和性能如何改进，具有可编写脚本的跟踪环境的能力都改变了一个重要的事实：到目前为止，度量标准是供应商选择的，封闭源和不完整的。 这迫使所有系统工程师开发推理技术 - 将来自多个工具的源和数据结合起来，试图弄清楚系统中发生了什么。 使用BPF，最终可以编写一个程序，能够准确地收集您正在寻找的信息。</p>
<h2 id="eBPF-anatomy"><a href="#eBPF-anatomy" class="headerlink" title="eBPF anatomy"></a>eBPF anatomy</h2><h3 id="Verifier"><a href="#Verifier" class="headerlink" title="Verifier"></a>Verifier</h3><p>BPF程序被加载并直接执行到内核中。 这意味着它正在跳过系统在用户空间中自动进行的大量安全检查。 例如，BPF程序中的错误可能会导致内核崩溃（可能会停止整个系统），或者循环情况会冻结整个系统（调度程序无法停止程序，因为我们不在 我们在用户空间中的流程抽象）。</p>
<p>因此，确保加载的程序是“安全的”绝对至关重要。 验证器完成此检查 - 该软件对正在加载的字节代码执行2阶段静态代码分析。 特别是：</p>
<ol>
<li>每个程序加载的指令不超过4096个：eBPF可能会处理大量数据，因此加载的程序很小并且不会成为系统的瓶颈非常重要。</li>
<li>检查循环和循环流：这些是不允许的，因为它们是不可预测的，并且可能在计算时间方面爆炸并成为系统的瓶颈。</li>
<li>无法访问的指令：这是为了确保BPF程序很小，加载速度快，执行速度快。 BPF程序应该具有运行所必需的功能。</li>
<li>跳转错误：验证程序确保跳转发生在程序边界内，而不是任何任意内存位置。这是至关重要的，因为BPF程序不应该损害系统，移动控制流或写入属于其他进程的内存</li>
<li>路径和流量评估：验证程序正在遍历程序并保持寄存器和堆栈状态的跟踪。如果有任何机会出现堆栈溢出或注册表溢出/下溢，验证程序将拒绝执行代码。同样，这是为了确保BPF程序不会损害系统。</li>
<li>参数有效性：这是为了确保程序试图在只读寄存器中写入，或者将一大块数据写入较小的寄存器，访问不存在的寄存器，调用未授权的内核函数。</li>
</ol>
<p>这些检查以及此处未列出的许多检查，它为我们提供了任何BPF程序的绝佳保证：它是沙箱。 它既不会伤害也不会减慢系统的速度。 这意味着生产安全。</p>
<p>如果您是软件供应商，并且您想向一家大公司提出您的软件，请说“请在您的计算机上运行此仪器软件”，或者您又是一家安全公司 - 您希望客户端安装特定的内核模块 在他们的生产机器上，公司的安全政策和担忧可能会减慢首次运行的时间。</p>
<p>通常，如果您是一家公司并且必须安装第三方内核模块，那么您必须承担风险。 您可能需要分析，分解，甚至可能需要手动检查源代码，以确保模块不会嗅探数据或在系统上运行恶意代码。</p>
<p>BPF正在改变规则。 如果您提供的BPF程序能够实现相同的功能，那么我现在有一套由验证程序提供的保证，因为它是一个带有一组有限指令的沙盒程序，默认情况下它不会损害 系统。 这是BPF计划获得大量支持的原因之一。</p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>BPF程序在内核中运行，但它们仍然必须以某种方式与用户空间程序进行通信，以便随时发回收集的信息以及最终累积的数据。 Maps用于此目的。</p>
<p>Maps是分配的通用内存区域（确切地说，它被声明为不透明的数据结构），可用于将数据从用户空间传输到内核，反之亦然 - 以及作为多个BPF程序之间的共享内存区域。 它最初被设想为哈希表，但是后续的内核版本也支持数组映射和其他数据结构。</p>
<p>这可能看起来只是一个小的补充（它实际上只是一个读/写内存区域），但它正在显着改变跟踪场景，特别是在实时用例中。</p>
<p>正如我们之前所探讨的，我们提到的所有跟踪工具都有一个特定的限制，它们已经遭受了多年的困扰：收集的数据必须以工具相关的格式写在磁盘上，然后，为了收集所需的统计信息， 我们不得不在我们的应用程序中再次加载该文件，解析它并提取所需的信息。</p>
<p>另一方面，使用Maps不需要存储数据，也不需要将数据解析回来进行后期处理：您只需将自己的结构直接从BPF程序返回到用户应用程序，就像您希望的那样 很容易为您的目的消耗，并最终直接从BPF程序收集统计数据（如递增计数器）。</p>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechat.jpg" alt="wyf WeChat Pay">
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="wyf Alipay">
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Tracing/" rel="tag"># Tracing</a>
          
            <a href="/tags/eBPF/" rel="tag"># eBPF</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        
          <div class="wp_rating">
            <div id="wpac-rating"></div>
          </div>
        

        

        
          
            <span class="post-meta-divider">|</span>
          
          <div class="social_share">
            
            
              <div id="needsharebutton-postbottom">
                <span class="btn">
                  <i class="fa fa-share-alt" aria-hidden="true"></i>
                </span>
              </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/22/2019-07-2019-07-22-k8s初部署/" rel="next" title="k8s初部署">
                <i class="fa fa-chevron-left"></i> k8s初部署
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/24/2019-07-2019-07-24-tracing2/" rel="prev" title="tracing2">
                tracing2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/logo.jpg" alt="wyf">
            
              <p class="site-author-name" itemprop="name">wyf</p>
              <p class="site-description motion-element" itemprop="description">bilibala~ bilibala~</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">69</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/wwyf" title="GitHub &rarr; https://github.com/wwyf" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/w.y.ff@163.com" title="E-Mail &rarr; w.y.ff@163.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://tongji.baidu.com/" title="http://tongji.baidu.com/" rel="noopener" target="_blank">百度统计</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://leancloud.cn" title="https://leancloud.cn" rel="noopener" target="_blank">leancloud</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://analytics.google.com" title="https://analytics.google.com" rel="noopener" target="_blank">Google分析</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://theme-next.iissnan.com/" title="http://theme-next.iissnan.com/" rel="noopener" target="_blank">Next主题配置文档</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hexo.io/docs/" title="https://hexo.io/docs/" rel="noopener" target="_blank">Hexo官方配置文档</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Tracing-Part1-Linux-中的新一代-tracing-技术"><span class="nav-number">1.</span> <span class="nav-text">Tracing Part1 | Linux 中的新一代 tracing 技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel-level-tracing-technologies-overview"><span class="nav-number">1.1.</span> <span class="nav-text">Kernel level tracing technologies overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Trace-points"><span class="nav-number">1.1.1.</span> <span class="nav-text">Trace points</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Probes"><span class="nav-number">1.1.2.</span> <span class="nav-text">Dynamic Probes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User-Level-Tracing-Tools"><span class="nav-number">1.2.</span> <span class="nav-text">User Level Tracing Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#perf"><span class="nav-number">1.2.1.</span> <span class="nav-text">perf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ftrace"><span class="nav-number">1.2.2.</span> <span class="nav-text">ftrace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-limitations"><span class="nav-number">1.2.3.</span> <span class="nav-text">Performance limitations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF"><span class="nav-number">1.3.</span> <span class="nav-text">eBPF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF-anatomy"><span class="nav-number">1.4.</span> <span class="nav-text">eBPF anatomy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Verifier"><span class="nav-number">1.4.1.</span> <span class="nav-text">Verifier</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maps"><span class="nav-number">1.4.2.</span> <span class="nav-text">Maps</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wyf</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Symbols count total: </span>
    
    <span title="Symbols count total">169k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    
    <span title="Reading time total">5:38</span>
  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.7.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  




  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function (item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'a53j2UQ5XFjm8AIynx8Wovci-gzGzoHsz',
    appKey: 'ze1twuRbEWoPuPsBloXMRXLo',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true
  });
</script>



  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  
  

  
  

  


  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>
  <script>
    
      pbOptions = {};
      
        pbOptions.iconStyle = "box";
      
        pbOptions.boxForm = "horizontal";
      
        pbOptions.position = "bottomCenter";
      
        pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
        flOptions.iconStyle = "box";
      
        flOptions.boxForm = "horizontal";
      
        flOptions.position = "middleRight";
      
        flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>


  
  <script>
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id: 16021,
      el: 'wpac-rating',
      color: 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  </script>


  
  
  
  <script src="/lib/pangu/dist/pangu.min.js?v=3.3"></script>
  <script>pangu.spacingPage();</script>


  
  <script src="/js/src/js.cookie.js?v=6.7.0"></script>
  <script src="/js/src/scroll-cookie.js?v=6.7.0"></script>


  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  
    bookmark.scrollToMark('auto', "#more");
  
  </script>


  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
